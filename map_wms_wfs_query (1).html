
<!doctype html>
<html lang="en">
 <head>
   <link rel="stylesheet" href="http://localhost:8080/webgis/libs/v6.5.0/css/ol.css" type="text/css">
    <link rel="stylesheet" href="http://localhost:8080/webgis/libs/v6.5.0/examples/resources/layout.css" type="text/css">
       <link rel="stylesheet" href="http://localhost:8080/webgis/libs/ol-layerswitcher/dist/ol-layerswitcher.css" />


    <script src="http://localhost:8080/webgis/libs/v6.5.0/build/ol.js"></script>
        <script src="http://localhost:8080/webgis/libs/ol-layerswitcher/dist/ol-layerswitcher.js"></script>
   <script src="http://localhost:8080/webgis/libs/jquery.min.js"></script>
   
   
  
  <link rel="stylesheet" href="http://localhost:8080/webgis/libs/bootstrap.min.css">
     <script type="text/javascript" src="http://localhost:8080/webgis/libs/bootstrap.min.js"></script>
    
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  
     
     

 
  
   <style>
   html,body {
  height: 100%;
  padding: 0;
  margin: 0;
    font-family: arial;
  
}
  #map{
     position: absolute;
      top: 0px;
           left: 20%;
    width: 80%;
     height: 100%;
      border: 1px solid #4CAF50;     
    }
    #left{
          width: 25%;
      left: 50px;
      top: 0%;
        }
    #wms_layers_btn{
  position: absolute;
  z-index:500;
    top: 5px;
     left: 60%;
        }
        #data{
          width: 60%; 
        }
     #table_data{
          position: absolute;
      bottom: 0px;
      overflow: scroll;
            left: 20%;
      right: 0px;
      height: 0%;
      border: 1px solid #4CAF50;
    }
    #table{
      white-space:nowrap;
    grid-template-areas:"head-fixed" "body-scrollable";
                 }
    #showData{
    overflow: auto;
          width: 100%;
                }


#table th {
  position: -webkit-sticky; /* for Safari */
  position: sticky;
  top: 0;
  background-color: darksalmon;
}
    
    #table_wms_layers {
      width: 100%;
    height: 350px;
      white-space:nowrap;
    border-collapse: separate;
    font-family: arial;
  font-size:14px;
     
        }
#table_wms_layers th {
  position: -webkit-sticky; /* for Safari */
  position: sticky;
  top: 0;
  background-color: darksalmon;
}
#clear_btn{
  position: absolute;
  z-index:500;
    top: 5px;
    left: 75%;
     
        }
.form-control {
   position: relative;
   top: 0px;
     width:18%;
   
           }
    .ol-mouse-position{
   top:97%;
   right:20%;
   position:absolute;
   font-weight: bold;
   }
     .layer-switcher.shown {
      max-height: 465px;
     }
   
   
   #legend{
      z-index: 11;
    padding: 2px 4px;
    border: 1px solid grey;
      position: absolute;
    bottom: 0px;
    height: 45%;
        overflow: scroll;
        width:20%; 
        left:0%;
    background-color: #ffffff;
    font-weight: bold;
    }
    
     .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "X";
      }
    #measure {
     position: absolute;
      z-index:50;
    top: 5px;
    height:15px;
    left: 10%;
     
    }
    #getinfo{
  position: absolute;
      z-index:50;
    top: 5px;
    height:15px;
    left: 35%;
     
        }
    
    .tooltip {
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: white;
        padding: 4px 8px;
        opacity: 0.7;
        white-space: nowrap;
      }
      .tooltip-measure {
        opacity: 1;
        font-weight: bold;
      }
      .tooltip-static {
        background-color: #ffcc33;
        color: black;
        border: 1px solid white;
      }
      .tooltip-measure:before,
      .tooltip-static:before {
        border-top: 6px solid rgba(0, 0, 0, 0.5);
        border-right: 6px solid transparent;
        border-left: 6px solid transparent;
        content: "";
        position: absolute;
        bottom: -6px;
        margin-left: -7px;
        left: 50%;
      }
      .tooltip-static:before {
        border-top-color: #ffcc33;
      }    
  
   </style>
   <style>
button.btn-settings {
  margin: 25px;
  padding: 20px 30px;
  font-size: 1.2em;
  background-color: #337ab7;
  color: white;
}
button.btn-settings:active {
  color: white;
}
.modal {
    overflow: hidden;
}
.modal-dialog {
    
  height:300px;
}
.modal-header {
  height:30px;
  padding: 20px;
  background-color:#18456b;
  color:white;
}
.modal-title {
  margin-top:-10px;
  font-size:16px;
}
.modal-header .close {
  margin-top:-10px;
  color:#fff;
}
.modal-body {
  color:#888;
  padding: 5px 35px 20px;
}
.modal-body h3 {
  text-align: center;
}
.modal-body p {
  padding-top:10px;
  font-size: 1.1em;
}
</style>

    <title>ASTS.</title>
  </head>

  <body>

   <div id="map"> 
    
    <form id="measure">
      <label>Measurement type &nbsp;</label>
      <select id="measuretype">
      <option value="select">Select Measure option</option>
        <option value="length">Length (LineString)</option>
        <option value="area">Area (Polygon)</option>
    <option value="clear">Clear Measurement</option>
      </select>
    </form>
  <form id="getinfo">
      <label>GetFeatureinfo&nbsp;</label>
      <select id="getinfotype">
    <option value="select">Select option</option>
      <option value="activate_getinfo">Activate GetFeatureinfo</option>
        <option value="deactivate_getinfo">Deactivate GetFeatureinfo</option>
        </select>
    </form>
  <button onclick="wms_layers()" id = "wms_layers_btn">Available WMS Layers</button>
  <button onclick="clear_all()" id = "clear_btn">Clear</button>

   </div>
   
   <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
   <div id="info">&nbsp;</div>
   
<div id="left">
<div id="legend"></div>
   <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#form">Select by Attributes</a></li>
        
  </ul>
  </div>

  <div class="tab-content">
  <div id="form" class="tab-pane fade in active">
  <label for="layer">Select Layer</label>
<select class="form-control" id="layer" name="layer">
<option value="">Select Layer</option>
</select>
<br>
<label for="attributes">Select attribute</label>
<select class="form-control" id="attributes" name="attributes">
<option value="">Select Attributes</option>
</select>
<br>
<label for="operator">Select operator</label>
<select class="form-control" id="operator" name="operator">
<option value="">Select operator</option>
</select>
<br>

<label for="value">Enter Value</label>
<input type="text" class="form-control" id="value" name="value">
<br>
<button class="btn btn-success" onclick="query()">Load Query</button>
</div>


</div>
<div id = "table_data"> </div>
<div id="wms_layers_window" title="Available WMS Layers" style="display:none"></div>
   <table id="table_wms_layers" class = "table-bordered">
     </table>

    <script type="text/javascript">
      var map, geojson, layer_name, layerSwitcher, featureOverlay; 
    var container, content, closer;

    
    var container = document.getElementById('popup');
      var content = document.getElementById('popup-content');
      var closer = document.getElementById('popup-closer');


      /**
       * Create an overlay to anchor the popup to the map.
       */
      var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
          duration: 250
        }
      });


      /**
       * Add a click handler to hide the popup.
       * @return {boolean} Don't follow the href.
       */
      closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
      };
  
  var view = new ol.View({
  projection: 'EPSG:4326',
         center: [-78.1834,-1.8312],
          zoom: 7,
      
        });
    var view_ov = new ol.View({
  projection: 'EPSG:4326',
        center: [-78.1834,-1.8312],
          zoom: 7,
        });
    
    
    var base_maps = new ol.layer.Group({
                'title': 'Base maps',
                layers: [
                        new ol.layer.Tile({
                        title: 'OSM',
                        type: 'base',
                        visible: true,
                        source: new ol.source.OSM()
                    })
                ]
            });
       
    var OSM = new ol.layer.Tile({
            source: new ol.source.OSM(),
      type: 'base',
      title: 'OSM',
          });
      
      var overlays = new ol.layer.Group({
                'title': 'Overlays',
                layers: [
   
    
    ]
    });
     
    
      var map = new ol.Map({
        target: 'map',
      view: view,
    overlays: [overlay]
        });
    
    map.addLayer(base_maps);
    map.addLayer(overlays);
    
    var rainfall = new ol.layer.Image({
      //title: 'Provincias',
       //opacity: 0.5,

         // extent: [-180, -90, -180, 90],
          //source: new ol.source.ImageWMS({
           // url: 'http://localhost:8080/geoserver/wms',
           // params: {'LAYERS': 'OrganizacionTerritorial:ORGANIZACIÓN TERRITORIAL PROVINCIAL'},
            //ratio: 1,
            //serverType: 'geoserver'
          })
        
    
    overlays.getLayers().push(rainfall);
    //map.addLayer(rainfall);
    
  var mouse_position = new ol.control.MousePosition();
  map.addControl(mouse_position);
  
var overview = new ol.control.OverviewMap({
view: view_ov, 
collapseLabel:'O', 
label: 'O',
layers:[OSM]
});

  map.addControl(overview);
  
  var full_sc = new ol.control.FullScreen({label:'F'});
  map.addControl(full_sc);
  
  var zoom = new ol.control.Zoom({zoomInLabel:'+', zoomOutLabel:'-'});
  map.addControl(zoom);
  
  var slider = new ol.control.ZoomSlider();
  map.addControl(slider);
  


  var zoom_ex = new ol.control.ZoomToExtent({
  extent:[
              65.90,7.48,
                    98.96,40.30
            ]
      });
  map.addControl(zoom_ex);
    
var layerSwitcher = new ol.control.LayerSwitcher({
    activationMode: 'click',
    startActive: true,
  tipLabel: 'Layers', // Optional label for button
    groupSelectStyle: 'children', // Can be 'children' [default], 'group' or 'none'
    collapseTipLabel: 'Collapse layers',
  });
  map.addControl(layerSwitcher);
  
    function legend () {
    
    $('#legend').empty();
    
    var no_layers = overlays.getLayers().get('length');
  
    var head = document.createElement("h4");
    
        var txt = document.createTextNode("Legend");
    
       head.appendChild(txt);
     var element = document.getElementById("legend");
       element.appendChild(head);
    var ar = [];
    var i;
    for (i = 0; i < no_layers; i++) {
    ar.push("http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+overlays.getLayers().item(i).get('title'));
    //alert(overlays.getLayers().item(i).get('title'));
    }
    for (i = 0; i < no_layers; i++) {
    var head = document.createElement("p");
    
        var txt = document.createTextNode(overlays.getLayers().item(i).get('title'));
    //alert(txt[i]);
       head.appendChild(txt);
     var element = document.getElementById("legend");
       element.appendChild(head);
     var img = new Image();
       img.src = ar[i];
      
      var src = document.getElementById("legend");
      src.appendChild(img);
 
     }
   
   }
   
   legend();
   
      
   
  
  function getinfo(evt) {
    var coordinate = evt.coordinate;
    var viewResolution = /** @type {number} */ (view.getResolution());

    $("#popup-content").empty();
    document.getElementById('info').innerHTML = '';

    var no_layers = overlays.getLayers().get('length');
    var url = new Array();
    var wmsSource = new Array();
    var layer_title = new Array();

    for (var i = 0; i < no_layers; i++) {
        var visibility = overlays.getLayers().item(i).getVisible();

        if (visibility == true) {
            layer_title[i] = overlays.getLayers().item(i).get('title');

            wmsSource[i] = new ol.source.ImageWMS({
                url: 'http://localhost:8080/geoserver/wms',
                params: { 'LAYERS': layer_title[i] },
                serverType: 'geoserver',
                crossOrigin: 'anonymous'
            });

            url[i] = wmsSource[i].getFeatureInfoUrl(
                evt.coordinate, viewResolution, 'EPSG:4326',
                { 'INFO_FORMAT': 'text/html' });

            $.get(url[i], function (data) {
                $("#popup-content").append(data);
                overlay.setPosition(coordinate);
                layerSwitcher.renderPanel();

                // Mostrar la información en el mapa en un popup
                var popup = new ol.Overlay({
                    element: document.getElementById('popup'),
                    positioning: 'bottom-center',
                    stopEvent: false,
                    offset: [0, -50]
                });
                map.addOverlay(popup);

                var content = document.getElementById('popup-content');
                content.innerHTML = data;
                popup.setPosition(coordinate);
            });
        }
    }
}

// Función que se ejecuta al cambiar el valor de getinfotype
getinfotype.onchange = function() {
    // Elimina cualquier interacción de dibujo activa
    map.removeInteraction(draw);

    // Limpia la capa de vectores si existe
    if (vectorLayer) { 
        vectorLayer.getSource().clear(); 
    }

    // Elimina el overlay de ayuda si existe
    map.removeOverlay(helpTooltip);

    // Elimina tooltips estáticos si existen
    if (measureTooltipElement) {
        var elem = document.getElementsByClassName("tooltip tooltip-static");
        for (var i = elem.length - 1; i >= 0; i--) {
            elem[i].remove();
        }
    }

    // Activa o desactiva el evento de clic según el valor seleccionado
    if (getinfotype.value == 'activate_getinfo') {
        map.on('singleclick', getinfo);
    } else if (getinfotype.value == 'select' || getinfotype.value == 'deactivate_getinfo') {
        map.un('singleclick', getinfo);
        overlay.setPosition(undefined);
        closer.blur();
    }
};

// Implementación de la función getinfo
// Función que se ejecuta al cambiar el valor de getinfotype
getinfotype.onchange = function() {
    // Elimina cualquier interacción de dibujo activa
    map.removeInteraction(draw);

    // Limpia la capa de vectores si existe
    if (vectorLayer) { 
        vectorLayer.getSource().clear(); 
    }

    // Elimina el overlay de ayuda si existe
    map.removeOverlay(helpTooltip);

    // Elimina tooltips estáticos si existen
    if (measureTooltipElement) {
        var elem = document.getElementsByClassName("tooltip tooltip-static");
        for (var i = elem.length - 1; i >= 0; i--) {
            elem[i].remove();
        }
    }

    // Activa o desactiva el evento de clic según el valor seleccionado
    if (getinfotype.value == 'activate_getinfo') {
        map.on('singleclick', getinfo);
    } else if (getinfotype.value == 'select' || getinfotype.value == 'deactivate_getinfo') {
        map.un('singleclick', getinfo);
        overlay.setPosition(undefined);
        closer.blur();
    }
};

// Implementación de la función getinfo
getinfotype.onchange = function() {
    map.removeInteraction(draw);

    if (vectorLayer) { 
        vectorLayer.getSource().clear(); 
    }

    map.removeOverlay(helpTooltip);

    if (measureTooltipElement) {
        var elem = document.getElementsByClassName("tooltip tooltip-static");
        for (var i = elem.length - 1; i >= 0; i--) {
            elem[i].remove();
        }
    }

    if (getinfotype.value == 'activate_getinfo') {
        map.on('singleclick', getinfo);
    } else if (getinfotype.value == 'select' || getinfotype.value == 'deactivate_getinfo') {
        map.un('singleclick', getinfo);
        overlay.setPosition(undefined);
        closer.blur();
    }
};

// Implementación de la función getinfo
function getinfo(evt) {
    var coordinate = evt.coordinate;
    var features = map.getFeaturesAtPixel(evt.pixel);

    if (features && features.length > 0) {
        var info = new Set();  // Usamos un Set para evitar duplicados
        var tableInfo = '';

        features.forEach(function(feature) {
            var properties = feature.getProperties();
            for (var key in properties) {
                if (properties.hasOwnProperty(key) && key !== 'geometry') {
                    var entry = '<b>' + key + ':</b> ' + properties[key];
                    if (!info.has(entry)) {  // Verifica si ya existe
                        info.add(entry);
                        tableInfo += '<tr><td>' + key + '</td><td>' + properties[key] + '</td></tr>';
                    }
                }
            }
        });

        var content = Array.from(info).join('<br>') || 'No hay información disponible';
        overlay.setPosition(coordinate);
        document.getElementById('popup-content').innerHTML = content;

        // Actualiza la tabla con la información
        document.getElementById('info-table-body').innerHTML = tableInfo;
    } else {
        overlay.setPosition(undefined);
        closer.blur();
    }
}

// Configuración del overlay (popup) en el mapa
var overlay = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: true,
    autoPanAnimation: {
        duration: 250,
    },
});
map.addOverlay(overlay);

var closer = document.getElementById('popup-closer');
closer.onclick = function() {
    overlay.setPosition(undefined);
    closer.blur();
    return false;
};


// Configuración del overlay (popup) en el mapa
var overlay = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: true,
    autoPanAnimation: {
        duration: 250,
    },
});
map.addOverlay(overlay);

// Configuración del botón de cierre del popup
var closer = document.getElementById('popup-closer');
closer.onclick = function() {
    overlay.setPosition(undefined);
    closer.blur();
    return false;
};


// measure tool

var source = new ol.source.Vector();
var vectorLayer = new ol.layer.Vector({
    source: source,
    style: new ol.style.Style({
        fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
        }),
        stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 2
        }),
        image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
                color: '#ffcc33'
            })
        })
    })
});

map.addLayer(vectorLayer);

var sketch;
var helpTooltipElement;
var helpTooltip;
var measureTooltipElement;
var measureTooltip;

var continuePolygonMsg = 'Click to continue drawing the polygon';
var continueLineMsg = 'Click to continue drawing the line';

var pointerMoveHandler = function(evt) {
    if (evt.dragging) {
        return;
    }

    var helpMsg = 'Click to start drawing';

    if (sketch) {
        var geom = sketch.getGeometry();
        if (geom instanceof ol.geom.Polygon) {
            helpMsg = continuePolygonMsg || 'Click to continue drawing the polygon';
        } else if (geom instanceof ol.geom.LineString) {
            helpMsg = continueLineMsg || 'Click to continue drawing the line';
        }
    }

    if (helpTooltipElement) {
        helpTooltipElement.innerHTML = helpMsg;
        helpTooltip.setPosition(evt.coordinate);
        helpTooltipElement.classList.remove('hidden');
    }
};

map.on('pointermove', pointerMoveHandler);

map.getViewport().addEventListener('mouseout', function() {
    if (helpTooltipElement) {
        helpTooltipElement.classList.add('hidden');
    }
});

var draw;

var formatLength = function(line) {
    var length = ol.sphere.getLength(line, { projection: 'EPSG:4326' });
    var output;
    if (length > 100) {
        output = (Math.round(length / 1000 * 100) / 100) + ' ' + 'km';
    } else {
        output = (Math.round(length * 100) / 100) + ' ' + 'm';
    }
    return output;
};

var formatArea = function(polygon) {
    var area = ol.sphere.getArea(polygon, { projection: 'EPSG:4326' });
    var output;
    if (area > 10000) {
        output = (Math.round(area / 1000000 * 100) / 100) + ' ' + 'km<sup>2</sup>';
    } else {
        output = (Math.round(area * 100) / 100) + ' ' + 'm<sup>2</sup>';
    }
    return output;
};


      function addInteraction() {

   var type;
   if (measuretype.value == 'area')
   { type = 'Polygon'; }
   else if (measuretype.value == 'length')
   {type = 'LineString';}
   //alert(type);
   
        //var type = (measuretype.value == 'area' ? 'Polygon' : 'LineString');
        draw = new ol.interaction.Draw({
          source: source,
          type: type,
          style: new ol.style.Style({
            fill: new ol.style.Fill({
              color: 'rgba(255, 255, 255, 0.5)'
            }),
            stroke: new ol.style.Stroke({
              color: 'rgba(0, 0, 0, 0.5)',
              lineDash: [10, 10],
              width: 2
            }),
            image: new ol.style.Circle({
              radius: 5,
              stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 0, 0.7)'
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.5)'
              })
            })
          })
        });
        
if (measuretype.value == 'select' || measuretype.value == 'clear')
{

map.removeInteraction(draw);
if (vectorLayer) {vectorLayer.getSource().clear();}
map.removeOverlay(helpTooltip);

if (measureTooltipElement) {
     var elem = document.getElementsByClassName("tooltip tooltip-static");
//$('#measure_tool').empty(); 

//alert(elem.length);
for(var i = elem.length-1; i >=0; i--)
{

elem[i].remove();
//alert(elem[i].innerHTML);
}     
        }

//var elem1 = elem[0].innerHTML;
//alert(elem1);

}

else if (measuretype.value == 'area' || measuretype.value == 'length')
{

map.addInteraction(draw);
        createMeasureTooltip();
        createHelpTooltip();

        var listener;
        draw.on('drawstart',
          function(evt) {
            // set sketch
      
    
      //vectorLayer.getSource().clear();
      
            sketch = evt.feature;

            /** @type {module:ol/coordinate~Coordinate|undefined} */
            var tooltipCoord = evt.coordinate;

            listener = sketch.getGeometry().on('change', function(evt) {
              var geom = evt.target;
        
              var output;
              if (geom instanceof ol.geom.Polygon) {
        
                output = formatArea(geom);
                tooltipCoord = geom.getInteriorPoint().getCoordinates();
        
              } else if (geom instanceof ol.geom.LineString) {
        
                output = formatLength(geom);
                tooltipCoord = geom.getLastCoordinate();
              }
              measureTooltipElement.innerHTML = output;
              measureTooltip.setPosition(tooltipCoord);
            });
          }, this);

        draw.on('drawend',
          function() {
            measureTooltipElement.className = 'tooltip tooltip-static';
            measureTooltip.setOffset([0, -7]);
            // unset sketch
            sketch = null;
            // unset tooltip so that a new one can be created
            measureTooltipElement = null;
            createMeasureTooltip();
            ol.Observable.unByKey(listener);
          }, this);
      
      }
      }


      /**
       * Creates a new help tooltip
       */
      function createHelpTooltip() {
        if (helpTooltipElement) {
          helpTooltipElement.parentNode.removeChild(helpTooltipElement);
        }
        helpTooltipElement = document.createElement('div');
        helpTooltipElement.className = 'tooltip hidden';
        helpTooltip = new ol.Overlay({
          element: helpTooltipElement,
          offset: [15, 0],
          positioning: 'center-left'
        });
        map.addOverlay(helpTooltip);
      }


      /**
       * Creates a new measure tooltip
       */
      function createMeasureTooltip() {
        if (measureTooltipElement) {
          measureTooltipElement.parentNode.removeChild(measureTooltipElement);
        }
        measureTooltipElement = document.createElement('div');
        measureTooltipElement.className = 'tooltip tooltip-measure';
     
        measureTooltip = new ol.Overlay({
          element: measureTooltipElement,
          offset: [0, -15],
          positioning: 'bottom-center'
        });
        map.addOverlay(measureTooltip);
    
      }


      /**
       * Let user change the geometry type.
       */
     measuretype.onchange = function() {
     map.un('singleclick', getinfo);
  overlay.setPosition(undefined);
        closer.blur();
     map.removeInteraction(draw);
        addInteraction();
      };
    
    // wms_layers_window
    
    function wms_layers()
{
//alert('jdgf');

$(function() {
  
       $( "#wms_layers_window" ).dialog({
          height: 400,
      width: 800,
          modal: true
        });
$( "#wms_layers_window" ).show();
   
 });
 
    $(document).ready(function(){
           $.ajax({
               type: "GET",
               url: "http://localhost:8080/geoserver/wms?request=getCapabilities",
               dataType: "xml",
               success: function(xml){
      $('#table_wms_layers').empty();
                 console.log("here");
        $('<tr></tr>').html('<th>Name</th><th>Title</th><th>Abstract</th>').appendTo('#table_wms_layers');
                   $(xml).find('Layer').find('Layer').each(function(){
                       var name = $(this).children('Name').text();
           // alert(name);
          //var name1 = name.find('Name').text();
          //alert(name);
                       var title = $(this).children('Title').text();
             
                       var abst = $(this).children('Abstract').text();
          //   alert(abst);
           

          //   alert('test');
              $('<tr></tr>').html('<td>' +name+ '</td><td>' +title+ '</td><td>' +abst+ '</td>').appendTo('#table_wms_layers');
            
            
                   });
           addRowHandlers();
               }
           });
   });
    
    
var divContainer = document.getElementById("wms_layers_window");
             var table1 = document.getElementById("table_wms_layers");
        divContainer.innerHTML = "";
        divContainer.appendChild(table1);
    $( "#wms_layers_window" ).show();
    
    var add_map_btn = document.createElement("BUTTON");
        add_map_btn.setAttribute("id", "add_map_btn");
    add_map_btn.innerHTML = "Add Layer to Map";
    add_map_btn.setAttribute("onclick", "add_layer()");
    divContainer.appendChild(add_map_btn);
  

function addRowHandlers() {
//alert('knd');
    var rows = document.getElementById("table_wms_layers").rows;
    var table = document.getElementById('table_wms_layers');
  var heads = table.getElementsByTagName('th');
  var col_no;
  for (var i = 0; i < heads.length; i++) {
        // Take each cell
        var head = heads[i];
    //alert(head.innerHTML);
    if (head.innerHTML == 'Name') 
    {
    col_no = i+1; 
    //alert(col_no);
    }

    }
    for (i = 0; i < rows.length; i++) {
  
        rows[i].onclick = function(){ return function(){
    
    $(function() {
        $("#table_wms_layers td").each(function() {
       $(this).parent("tr").css("background-color", "white");
       });
       });
              var cell = this.cells[col_no-1];
               layer_name = cell.innerHTML;
        // alert(layer_name);
         
          $(document).ready(function () {
    $("#table_wms_layers td:nth-child("+col_no+")").each(function () {
        if ($(this).text() == layer_name) {
            $(this).parent("tr").css("background-color", "grey");
      
      
      
        }
    });
});

               //alert("id:" + id);
        };}(rows[i]);
    }
   /*$("#add_map_btn").click(function () {
       // var value = $(".selected td:first").html();
       // value = value || "No row Selected";
        alert(layer_name);
    });*/
}

}

function add_layer()
            {
      //alert("jd"); 
      
//alert(layer_name);
//map.removeControl(layerSwitcher);

var name = layer_name.split(":");
            
      var layer_wms = new ol.layer.Image({
      title: name[1],
         // extent: [-180, -90, -180, 90],
          source: new ol.source.ImageWMS({
            url: 'http://localhost:8080/geoserver/wms',
            params: {'LAYERS': layer_name},
            ratio: 1,
            serverType: 'geoserver'
          })
        });
    overlays.getLayers().push(layer_wms);
      
    var url = 'http://localhost:8080/geoserver/wms?request=getCapabilities';
    var parser = new ol.format.WMSCapabilities();


    $.ajax(url).then(function (response) {
        //window.alert("word");
        var result = parser.read(response);
       // console.log(result);
       // window.alert(result);
        var Layers = result.Capability.Layer.Layer;
        var extent;
        for (var i = 0, len = Layers.length; i < len; i++) {

            var layerobj = Layers[i];
          //  window.alert(layerobj.Name);

            if (layerobj.Name == layer_name)
            {
                extent = layerobj.BoundingBox[0].extent;
        //alert(extent);
         map.getView().fit(
            extent,
        { duration: 1590, size: map.getSize() }
    );
        
            }
        }
    });
    //alert(layer_wms.get('source').get('extent'));
    /*layer_wms.getSource().on('singleclick', function(){
    map.getView().fit(
        layer_wms.getExtent(),
        { duration: 1590, size: map.getSize() }
    );
 });*/
    
    layerSwitcher.renderPanel();
    //map.addControl(layerSwitcher);
    legend();
    //map.addLayer(layer_wms);
      }
    
// layers_name
    $(document).ready(function(){
  $.ajax({
    type: "GET",
    url: "http://localhost:8080/geoserver/wfs?request=getCapabilities",
    dataType: "xml",
    success: function(xml) {
      var select = $('#layer');
      $(xml).find('FeatureType').each(function(){
        var name = $(this).find('Name').text();
        var title = $(this).find('Title').text();  // Obtiene el título de la capa
        select.append("<option class='ddindent' value='"+ name +"'>"+ title +"</option>");
      });
      //select.children(":first").text("please make a selection").attr("selected",true);
    }
  });
});

    // attributes_dropdown

$(function () {
  $("#layer" ).change(function () {
  
    var attributes = document.getElementById("attributes");
var length = attributes.options.length;
for (i = length-1; i >= 0; i--) {
  attributes.options[i] = null;
}
  
    var value_layer = $(this).val();
   
    
attributes.options[0] = new Option('Select attributes', "");
    //  alert(url);
    
      $(document).ready(function(){
      $.ajax({
        type: "GET",
        url: "http://localhost:8080/geoserver/wfs?service=WFS&request=DescribeFeatureType&version=1.1.0&typeName="+value_layer,
        dataType: "xml",
        success: function(xml) {
        
        var select = $('#attributes');
        //var title = $(xml).find('xsd\\:complexType').attr('name');
      //  alert(title);
        $(xml).find('xsd\\:sequence').each(function(){
        
        $(this).find('xsd\\:element').each(function(){
        var value = $(this).attr('name');
        //alert(value);
        var type = $(this).attr('type');
        //alert(type);
        if (value != 'geom' && value != 'the_geom') {
        select.append("<option class='ddindent' value='"+ type +"'>"+value+"</option>");
        }
        });
        
        });
        }
      });
    });
  
  
});
});


// operator combo
$(function () {
  $("#attributes" ).change(function () {
  
    var operator = document.getElementById("operator");
var length = operator.options.length;
for (i = length-1; i >= 0; i--) {
  operator.options[i] = null;
}
  
    var value_type = $(this).val();
   // alert(value_type);
    var value_attribute = $('#attributes option:selected').text();
operator.options[0] = new Option('Select operator', "");

    if (value_type == 'xsd:short' || value_type == 'xsd:int' || value_type == 'xsd:double')
      {
      var operator1 = document.getElementById("operator");
      operator1.options[1] = new Option('Greater than', '>');
      operator1.options[2] = new Option('Less than', '<');
      operator1.options[3] = new Option('Equal to', '=');
      }
      else if (value_type == 'xsd:string')
      {
      var operator1 = document.getElementById("operator");
      operator1.options[1] = new Option('Like', 'ILike');
      
      }

});
});

   var highlightStyle = new ol.style.Style({
  fill: new ol.style.Fill({
    color: 'rgba(255,255,255,0.7)',
  }),
  stroke: new ol.style.Stroke({
    color: '#3399CC',
    width: 3,
  }),
 image: new ol.style.Circle({
            radius: 10,
            fill: new ol.style.Fill({
              color: '#3399CC'
            })
          })
});

 featureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
        map: map,
    style: highlightStyle
      });
    
    
    function findRowNumber(cn1, v1){

  var table = document.querySelector('#table');
  var rows = table.querySelectorAll("tr");
  var msg = "No such row exist"
  for(i=1;i<rows.length;i++){
    var tableData = rows[i].querySelectorAll("td");
    if(tableData[cn1-1].textContent==v1){
      msg = i;
      break;
    }
  }
  return msg;
}


function addRowHandlers() {
    var rows = document.getElementById("table").rows;
  var heads = table.getElementsByTagName('th');
  var col_no;
  for (var i = 0; i < heads.length; i++) {
        // Take each cell
        var head = heads[i];
    //alert(head.innerHTML);
    if (head.innerHTML == 'id') 
    {
    col_no = i+1; 
    //alert(col_no);
    }

    }
    for (i = 0; i < rows.length; i++) {
  
    
  
        rows[i].onclick = function(){ return function(){
    featureOverlay.getSource().clear();
    
    $(function() {
        $("#table td").each(function() {
       $(this).parent("tr").css("background-color", "white");
       });
       });
              var cell = this.cells[col_no-1];
               var id = cell.innerHTML;
         
         
          $(document).ready(function () {
    $("#table td:nth-child("+col_no+")").each(function () {
        if ($(this).text() == id) {
            $(this).parent("tr").css("background-color", "grey");
        }
    });
});

var features = geojson.getSource().getFeatures();
//alert(features.length);


for (i=0; i< features.length; i++)
{



if (features[i].getId() == id)
{
featureOverlay.getSource().addFeature(features[i]);

    featureOverlay.getSource().on('addfeature', function(){
    map.getView().fit(
        featureOverlay.getSource().getExtent(),
        { duration: 1590, size: map.getSize() }
    );
 });
  
}
}

               //alert("id:" + id);
        };}(rows[i]);
    }
}


    
    function  highlight(evt) {
    featureOverlay.getSource().clear();
    var feature = map.forEachFeatureAtPixel(evt.pixel,
      function(feature, layer) {
        return feature;
      });
    
    if (feature) {
  
        var geometry = feature.getGeometry();
        var coord = geometry.getCoordinates();
    var coordinate = evt.coordinate;
       
     $(function() {
        $("#table td").each(function() {
       $(this).parent("tr").css("background-color", "white");
       });
       });
      
        featureOverlay.getSource().addFeature(feature);
    }
  


var table = document.getElementById('table');
    var cells = table.getElementsByTagName('td');
  var rows = document.getElementById("table").rows;
  var heads = table.getElementsByTagName('th');
  var col_no;
  for (var i = 0; i < heads.length; i++) {
        // Take each cell
        var head = heads[i];
    //alert(head.innerHTML);
    if (head.innerHTML == 'id') 
    {
    col_no = i+1; 
    //alert(col_no);
    }

    }
    var row_no = findRowNumber(col_no, feature.getId());
    //alert(row_no);
    
    var rows = document.querySelectorAll('#table tr');

rows[row_no].scrollIntoView({
    behavior: 'smooth',
    block: 'center'
});

      $(document).ready(function () {
    $("#table td:nth-child("+col_no+")").each(function () {
  
        if ($(this).text() == feature.getId()) {
            $(this).parent("tr").css("background-color", "grey");
      
        }
    });
});




  };  
  
function query(){

$('#table').empty();
if(geojson)
    {
    map.removeLayer(geojson);
    
    }
    
    if(featureOverlay)
    {
    featureOverlay.getSource().clear();
    map.removeLayer(featureOverlay);
    
    }
  //alert('jsbchdb'); 
var layer = document.getElementById("layer");
var value_layer = layer.options[layer.selectedIndex].value;
//alert(value_layer);

var attribute = document.getElementById("attributes");
var value_attribute = attribute.options[attribute.selectedIndex].text;
//alert(value_attribute);

var operator = document.getElementById("operator");
var value_operator = operator.options[operator.selectedIndex].value;
//alert(value_operator);

var txt = document.getElementById("value");
var value_txt = txt.value;

if (value_operator == 'ILike')
      {
      value_txt = ""+value_txt+"%25";
      //alert(value_txt);
      //value_attribute = 'strToLowerCase('+value_attribute+')';
      }
      else{
      value_txt = value_txt;
      //value_attribute = value_attribute;
      }
//alert(value_txt);


 var url = "http://localhost:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+value_layer+"&CQL_FILTER="+value_attribute+"+"+value_operator+"+'"+value_txt+"'&outputFormat=application/json"
//alert(url);

var style = new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.7)'
          }),
          stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 3
          }),
     /* image: new ol.style.Icon({
    anchor: [0.5, 46],
    anchorXUnits: 'fraction',
    anchorYUnits: 'pixels',
    src: 'img/marker.png',
  }),*/
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#ffcc33'
            })
          })
        });
    
  

     geojson = new ol.layer.Vector({
      //title:'dfdfd',
   //title: '<h5>' + value_crop+' '+ value_param +' '+ value_seas+' '+value_level+'</h5>',
          source: new ol.source.Vector({
     url: url,
          format: new ol.format.GeoJSON()
          }),
      style: style,
     
        });
    
    geojson.getSource().on('addfeature', function(){
    //alert(geojson.getSource().getExtent());
    map.getView().fit(
        geojson.getSource().getExtent(),
        { duration: 1590, size: map.getSize() }
    );
 });
 
 //overlays.getLayers().push(geojson);
    map.addLayer(geojson);
    
  
    $.getJSON(url, function(data) {
   var col = [];
   col.push('id');
        for (var i = 0; i < data.features.length; i++) {
    
            for (var key in data.features[i].properties) {
      
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }
    
    
  
    var table = document.createElement("table");
    
    
table.setAttribute("class", "table table-bordered");
table.setAttribute("id", "table");
        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < data.features.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
        if (j == 0) {tabCell.innerHTML = data.features[i]['id'];}
        else{
        //alert(data.features[i]['id']);
                tabCell.innerHTML = data.features[i].properties[col[j]];
        //alert(tabCell.innerHTML);
        }
            }
        }
    
      

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("table_data");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    addRowHandlers();
    
   document.getElementById('map').style.height='75%';
    document.getElementById('table_data').style.height='25%';
  map.updateSize();
});
  
  
  map.on('click', highlight);
  
addRowHandlers();

}

  function clear_all()
    {
    document.getElementById('map').style.height='100%';
    document.getElementById('table_data').style.height='0%';
  map.updateSize();
  $('#table').empty();
  //$('#table1').empty();
  if (geojson) {geojson.getSource().clear(); map.removeLayer(geojson);}
  if (featureOverlay) {featureOverlay.getSource().clear(); map.removeLayer(featureOverlay);}
    map.removeInteraction(draw);
if (vectorLayer) {vectorLayer.getSource().clear();}
map.removeOverlay(helpTooltip);
    if (measureTooltipElement) {
     var elem = document.getElementsByClassName("tooltip tooltip-static");
     
    for(var i = elem.length-1; i >=0; i--)
       {

elem[i].remove();
//alert(elem[i].innerHTML);
       }     
        }
    map.un('singleclick', getinfo);
  overlay.setPosition(undefined);
        closer.blur();
    
map.un('click', highlight);

  
    }
    
    </script>
  
  </body>
</html>